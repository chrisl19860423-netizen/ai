# AI Siri Gateway

一个轻量级的 AI 中转网关，用于 HomePod / iPhone 快捷指令调用 OpenAI 兼容的 Chat Completions API。

## 功能特性

- ✅ 简单的 API Key 鉴权
- ✅ 支持三种模式：idea、todo、daily
- ✅ 零第三方依赖，使用 Node.js 原生 fetch
- ✅ 一键部署到 Vercel
- ✅ 完整的错误处理和超时控制

## 项目结构

```
.
├── api/
│   └── ai.js          # 主 API 接口
├── package.json       # 项目配置
└── README.md          # 本文档
```

## 本地运行（可选）

### 前置要求

- Node.js 18+ （支持原生 fetch）
- Vercel CLI（可选，用于本地测试）

### 安装 Vercel CLI

```bash
npm i -g vercel
```

### 运行

```bash
# 安装依赖（实际上没有依赖，但可以运行）
npm install

# 使用 Vercel CLI 本地运行
vercel dev
```

本地运行需要设置环境变量，可以通过 `.env.local` 文件或 Vercel CLI 的交互式设置。

## 部署到 Vercel

### 方法一：通过 Vercel CLI

1. **安装 Vercel CLI**（如果还没安装）
   ```bash
   npm i -g vercel
   ```

2. **登录 Vercel**
   ```bash
   vercel login
   ```

3. **部署**
   ```bash
   vercel
   ```
   
   首次部署会提示：
   - 是否链接到现有项目？选择 `N`
   - 项目名称：输入你的项目名（或直接回车）
   - 目录：直接回车（使用当前目录）

4. **设置环境变量**（见下方"环境变量配置"）

5. **生产环境部署**
   ```bash
   vercel --prod
   ```

### 方法二：通过 GitHub（推荐）

1. **将代码推送到 GitHub**

2. **在 Vercel 网站导入项目**
   - 访问 [vercel.com](https://vercel.com)
   - 点击 "Add New Project"
   - 选择你的 GitHub 仓库
   - 点击 "Import"

3. **配置环境变量**（见下方）

4. **部署**
   - Vercel 会自动检测并部署
   - 每次推送到主分支会自动触发部署

## 环境变量配置

在 Vercel 项目设置中，添加以下环境变量：

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `GATEWAY_API_KEY` | 网关鉴权密钥（客户端请求头需携带此值） | `your-secret-key-123` |
| `UPSTREAM_KEY` | 上游 AI 服务的 API Key | `sk-xxx...` |
| `UPSTREAM_BASE` | 上游 AI 服务的 Base URL | `https://api.openai.com/v1` 或 `https://api.deepseek.com/v1` |
| `MODEL` | 使用的模型名称（可选，默认 gpt-3.5-turbo） | `gpt-4` 或 `deepseek-chat` |

### 在 Vercel 中设置环境变量

1. 进入项目 Dashboard
2. 点击 **Settings** → **Environment Variables**
3. 添加上述四个变量
4. 选择环境（Production、Preview、Development）
5. 点击 **Save**
6. 重新部署项目使环境变量生效

## API 接口说明

### 端点

```
POST https://your-project.vercel.app/api/ai
```

### 请求头

```
Content-Type: application/json
x-api-key: your-secret-key-123  # 必须等于 GATEWAY_API_KEY
```

### 请求体

```json
{
  "text": "用户输入的文本内容",
  "mode": "idea"  // 可选值：idea | todo | daily
}
```

### 响应

**成功响应（200）**
```json
{
  "reply": "AI 返回的回复内容"
}
```

**错误响应（401）**
```json
{
  "error": "Unauthorized: Invalid API key"
}
```

**错误响应（400）**
```json
{
  "error": "Missing or invalid \"text\" field"
}
```

**错误响应（500）**
```json
{
  "error": "Failed to process AI request",
  "detail": "具体错误信息（最多300字）"
}
```

## iPhone 快捷指令配置（详细步骤）

### 准备工作

在开始之前，请准备好以下信息：
- **API 地址**：`https://ai-teal-eight-97.vercel.app/api/ai`（替换为你的实际地址）
- **API Key**：你在 Vercel 环境变量中设置的 `GATEWAY_API_KEY` 的值

---

### 步骤 1：打开快捷指令 App

1. 在 iPhone 上找到并打开 **"快捷指令"** App（Shortcuts）
2. 如果找不到，可以在 App Store 搜索 "快捷指令" 下载

---

### 步骤 2：创建新快捷指令

1. 点击屏幕右上角的 **"+"** 按钮（蓝色加号）
2. 点击 **"添加操作"** 按钮

---

### 步骤 3：添加"询问输入"操作（获取用户输入）

1. 在搜索框中输入 **"询问输入"**
2. 选择 **"询问输入"** 操作
3. 点击 **"输入类型"**，选择 **"文本"**
4. 在 **"提示"** 框中输入：`你想说什么？`（或你喜欢的提示文字）
5. 点击右上角 **"完成"**

---

### 步骤 4：添加"获取网页内容"操作（调用 API）

1. 点击 **"+"** 添加新操作
2. 在搜索框中输入 **"获取网页内容"**
3. 选择 **"获取网页内容"** 操作

**配置 URL：**
- 点击 **"URL"** 字段
- 输入：`https://ai-teal-eight-97.vercel.app/api/ai`（替换为你的实际地址）
- 点击 **"完成"**

**配置方法：**
- 点击 **"方法"** 字段
- 选择 **"POST"**

**配置请求头：**
- 点击 **"请求头"** 旁边的 **"显示更多"** 或直接点击展开
- 点击 **"添加新字段"**
  - **键**：输入 `x-api-key`
  - **值**：输入你的 `GATEWAY_API_KEY` 值（例如：`your-secret-key-123`）
- 再点击 **"添加新字段"**
  - **键**：输入 `Content-Type`
  - **值**：输入 `application/json`

**配置请求体：**
- 点击 **"请求体"** 字段
- 选择 **"JSON"**
- 在 JSON 文本框中输入以下内容（注意：`{{询问输入}}` 会自动显示为变量）：
```json
{
  "text": "{{询问输入}}",
  "mode": "idea"
}
```
> 💡 提示：输入 `{{` 后，会自动弹出变量选择，选择 **"询问输入"** 即可

- 点击 **"完成"**

---

### 步骤 5：解析 API 返回的 JSON

1. 点击 **"+"** 添加新操作
2. 在搜索框中输入 **"从输入中获取词典值"**
3. 选择 **"从输入中获取词典值"** 操作
4. 点击 **"键"** 字段，输入：`reply`
5. 确保 **"输入"** 来源是 **"获取网页内容"**（会自动识别）
6. 点击 **"完成"**

---

### 步骤 6：显示结果

**方式一：显示通知（推荐）**

1. 点击 **"+"** 添加新操作
2. 在搜索框中输入 **"显示通知"**
3. 选择 **"显示通知"** 操作
4. 点击 **"通知的正文"** 字段
5. 点击输入框，选择 **"从输入中获取词典值"**（会自动识别）
6. 在 **"通知的标题"** 中输入：`AI 回复`
7. 点击 **"完成"**

**方式二：朗读文本（适合语音场景）**

1. 点击 **"+"** 添加新操作
2. 在搜索框中输入 **"朗读文本"**
3. 选择 **"朗读文本"** 操作
4. 点击 **"文本"** 字段
5. 选择 **"从输入中获取词典值"**（会自动识别）
6. 点击 **"完成"**

---

### 步骤 7：保存并命名快捷指令

1. 点击屏幕顶部的 **"新建快捷指令"** 文字
2. 输入快捷指令名称，例如：`AI 助手 - Idea`
3. 可以选择一个图标和颜色
4. 点击右上角 **"完成"**

---

### 步骤 8：测试快捷指令

1. 在快捷指令列表中，点击你刚创建的快捷指令
2. 输入一些测试文字，例如：`我想做一个时间管理App`
3. 点击 **"完成"**
4. 等待几秒钟，应该会看到 AI 的回复

---

### 创建多个快捷指令（不同模式）

你可以创建三个快捷指令，分别对应不同的模式：

**快捷指令 1：AI 助手 - Idea**
- 请求体中的 `mode` 设置为：`"idea"`

**快捷指令 2：AI 助手 - Todo**
- 请求体中的 `mode` 设置为：`"todo"`

**快捷指令 3：AI 助手 - Daily**
- 请求体中的 `mode` 设置为：`"daily"`

---

### 添加到 Siri（可选）

1. 打开快捷指令 App
2. 找到你创建的快捷指令
3. 点击快捷指令右侧的 **"..."** 按钮
4. 点击右上角的 **"..."** 菜单
5. 选择 **"添加到 Siri"**
6. 录制一个语音命令，例如：`AI 助手`
7. 完成后，你可以对 Siri 说：`嘿 Siri，AI 助手` 来触发快捷指令

---

### 常见问题

**Q: 找不到"获取网页内容"操作？**
A: 确保你的 iOS 版本是 12.0 或更高。如果找不到，尝试搜索 "HTTP" 或 "URL"。

**Q: 提示"无法连接到服务器"？**
A: 
- 检查 API 地址是否正确
- 检查 `x-api-key` 是否正确
- 确认 Vercel 部署是否成功

**Q: 返回错误信息？**
A: 
- 检查请求体 JSON 格式是否正确
- 确认 `mode` 的值是 `idea`、`todo` 或 `daily` 之一
- 查看返回的错误信息，根据提示修改

**Q: 如何修改 API 地址？**
A: 在快捷指令中，点击 **"获取网页内容"** 操作，修改 **"URL"** 字段即可。

---

### 完整操作流程图

```
开始
  ↓
询问输入（文本："你想说什么？"）
  ↓
获取网页内容
  ├─ URL: https://your-project.vercel.app/api/ai
  ├─ 方法: POST
  ├─ 请求头:
  │   ├─ x-api-key: your-secret-key-123
  │   └─ Content-Type: application/json
  └─ 请求体: {"text": "{{询问输入}}", "mode": "idea"}
  ↓
从输入中获取词典值（键：reply）
  ↓
显示通知（内容：{{词典值}}）
  ↓
完成
```

### 三种 Mode 的使用场景

#### `mode: "idea"` - 想法总结
**用途**：快速总结想法并给出下一步建议

**示例输入**：
```
我想做一个时间管理的 App，帮助用户记录每天的时间分配
```

**示例输出**：
```
这是一个时间管理 App 的想法，目标是帮助用户记录和分析时间分配。下一步建议：先做一个简单的 MVP，包含手动记录时间的功能。
```

#### `mode: "todo"` - 任务规划
**用途**：将想法转化为可执行的任务列表

**示例输入**：
```
我要准备下周的会议演讲
```

**示例输出**：
```
目标：完成下周会议演讲的准备工作

TODO：
- P1: 确定演讲主题和核心内容框架
- P2: 准备 PPT 演示文稿
- P3: 提前演练并准备问答环节

第一最小动作：打开文档，写下演讲的3个核心要点
```

#### `mode: "daily"` - 日常复盘
**用途**：每日总结和规划

**示例输入**：
```
今天完成了项目文档，但遇到了 API 接口超时的问题，明天需要修复并测试
```

**示例输出**：
```
Progress（进展）：
- 完成了项目文档编写
- 梳理了项目架构和接口设计

Problem（问题）：
- API 接口出现超时问题，影响用户体验

Plan（计划）：
- 明天修复 API 超时问题
- 进行完整的接口测试
- 优化错误处理机制
```

## 安全建议

1. **保护 API Key**：`GATEWAY_API_KEY` 应该使用强随机字符串，不要泄露
2. **HTTPS 强制**：Vercel 默认使用 HTTPS，确保所有请求都通过 HTTPS
3. **限制访问**：可以考虑在 Vercel 中添加 IP 白名单（通过 Vercel 的 Edge Config 或 Middleware）

## 故障排查

### 401 Unauthorized
- 检查请求头 `x-api-key` 是否正确
- 检查 Vercel 环境变量 `GATEWAY_API_KEY` 是否设置

### 500 Internal Server Error
- 检查 Vercel 环境变量 `UPSTREAM_KEY` 和 `UPSTREAM_BASE` 是否正确
- 查看 Vercel 日志：Dashboard → Deployments → 选择部署 → Logs

### 超时错误
- 默认超时时间为 30 秒
- 如果上游 API 响应慢，可以修改 `api/ai.js` 中的超时时间

## 许可证

MIT

